<?php
/**
 * Plugin Name: UserInfo Manager
 * Plugin URI: https://example.com
 * Description: Custom post type for managing user information with frontend form submission, including image upload/remove/replace, submission date tracking, month filtering, and CSV export
 * Version: 1.4.4
 * Author: Your Name
 * Author URI: https://example.com
 * License: GPL v2 or later
 * License URI: https://www.gnu.org/licenses/gpl-2.0.html
 * Text Domain: userinfo-manager
 */

// Prevent direct access
if (!defined('ABSPATH')) {
    exit;
}

/**
 * Register UserInfo Custom Post Type
 */
function userinfo_register_post_type() {
    $labels = array(
        'name'                  => _x('User Info', 'Post type general name', 'userinfo-manager'),
        'singular_name'         => _x('User Info', 'Post type singular name', 'userinfo-manager'),
        'menu_name'             => _x('User Info', 'Admin Menu text', 'userinfo-manager'),
        'name_admin_bar'        => _x('User Info', 'Add New on Toolbar', 'userinfo-manager'),
        'add_new'               => __('Add New', 'userinfo-manager'),
        'add_new_item'          => __('Add New User Info', 'userinfo-manager'),
        'new_item'              => __('New User Info', 'userinfo-manager'),
        'edit_item'             => __('Edit User Info', 'userinfo-manager'),
        'view_item'             => __('View User Info', 'userinfo-manager'),
        'all_items'             => __('All User Info', 'userinfo-manager'),
        'search_items'          => __('Search User Info', 'userinfo-manager'),
        'not_found'             => __('No user info found.', 'userinfo-manager'),
        'not_found_in_trash'    => __('No user info found in Trash.', 'userinfo-manager'),
    );

    $args = array(
        'labels'                => $labels,
        'description'           => __('User information submitted via frontend form', 'userinfo-manager'),
        'public'                => false,
        'publicly_queryable'    => false,
        'show_ui'               => true,
        'show_in_menu'          => true,
        'query_var'             => true,
        'rewrite'               => array('slug' => 'userinfo'),
        'capability_type'       => 'post',
        'has_archive'           => false,
        'hierarchical'          => false,
        'menu_position'         => 20,
        'menu_icon'             => 'dashicons-id-alt',
        'supports'              => array('title'),
        'show_in_rest'          => false,
    );

    register_post_type('userinfo', $args);
}
add_action('init', 'userinfo_register_post_type');

/**
 * Enqueue frontend styles and scripts
 * Version: 1.4.4 - Removed all inline styles and scripts
 */
function userinfo_enqueue_frontend_assets() {
    $plugin_version = '1.4.4';

    // Enqueue CSS with high priority to ensure it loads
    wp_enqueue_style(
        'userinfo-frontend-styles',
        plugin_dir_url(__FILE__) . 'assets/css/userinfo-frontend.css',
        array(),
        $plugin_version,
        'all'
    );

    // Enqueue jQuery (WordPress core)
    wp_enqueue_script('jquery');

    // Enqueue custom JavaScript
    wp_enqueue_script(
        'userinfo-frontend-script',
        plugin_dir_url(__FILE__) . 'assets/js/userinfo-frontend.js',
        array('jquery'),
        $plugin_version,
        true // Load in footer
    );

    // Localize script for translations and AJAX
    wp_localize_script('userinfo-frontend-script', 'userinfo_l10n', array(
        'ajax_url' => admin_url('admin-ajax.php'),
        'verifying' => __('Verifying...', 'userinfo-manager'),
        'verify_user' => __('Verify User', 'userinfo-manager'),
        'user_found' => __('User Found', 'userinfo-manager'),
        'full_name' => __('Full Name', 'userinfo-manager'),
        'username' => __('Username', 'userinfo-manager'),
        'agent_id' => __('Agent ID', 'userinfo-manager'),
        'phone' => __('Phone', 'userinfo-manager'),
        'nid' => __('NID', 'userinfo-manager'),
        'status' => __('Status', 'userinfo-manager'),
        'nid_image' => __('NID Image', 'userinfo-manager'),
        'error_occurred' => __('An error occurred. Please try again.', 'userinfo-manager'),
    ));
}
add_action('wp_enqueue_scripts', 'userinfo_enqueue_frontend_assets', 10);

/**
 * Add enctype to post form for file uploads
 */
function userinfo_add_enctype_to_post_form() {
    global $post;
    if ($post && $post->post_type == 'userinfo') {
        echo ' enctype="multipart/form-data"';
    }
}
add_action('post_edit_form_tag', 'userinfo_add_enctype_to_post_form');

/**
 * Add custom meta boxes for name and email
 */
function userinfo_add_meta_boxes() {
    add_meta_box(
        'userinfo_details',
        __('User Details', 'userinfo-manager'),
        'userinfo_meta_box_callback',
        'userinfo',
        'normal',
        'high'
    );
}
add_action('add_meta_boxes', 'userinfo_add_meta_boxes');

/**
 * Meta box display callback
 */
function userinfo_meta_box_callback($post) {
    // Add nonce for security
    wp_nonce_field('userinfo_save_meta_box_data', 'userinfo_meta_box_nonce');

    // Retrieve existing values
    $full_name = get_post_meta($post->ID, '_userinfo_full_name', true);
    $username = get_post_meta($post->ID, '_userinfo_username', true);
    $agent_id = get_post_meta($post->ID, '_userinfo_agent_id', true);
    $phone_number = get_post_meta($post->ID, '_userinfo_phone_number', true);
    $nid_number = get_post_meta($post->ID, '_userinfo_nid_number', true);
    $submitted_date = get_post_meta($post->ID, '_userinfo_submitted_date', true);
    $nid_image_id = get_post_meta($post->ID, '_userinfo_nid_image', true);
    $is_valid = get_post_meta($post->ID, '_userinfo_is_valid', true);

    // Default to valid (1) if not set
    if ($is_valid === '') {
        $is_valid = '1';
    }

    ?>
    <table class="form-table">
        <tr>
            <th><label for="userinfo_full_name"><?php _e('Full Name', 'userinfo-manager'); ?></label></th>
            <td>
                <input type="text" id="userinfo_full_name" name="userinfo_full_name" value="<?php echo esc_attr($full_name); ?>" class="regular-text" required />
            </td>
        </tr>
        <tr>
            <th><label for="userinfo_username"><?php _e('Username', 'userinfo-manager'); ?></label></th>
            <td>
                <input type="text" id="userinfo_username" name="userinfo_username" value="<?php echo esc_attr($username); ?>" class="regular-text" required />
            </td>
        </tr>
        <tr>
            <th><label for="userinfo_agent_id"><?php _e('Agent ID', 'userinfo-manager'); ?></label></th>
            <td>
                <input type="text" id="userinfo_agent_id" name="userinfo_agent_id" value="<?php echo esc_attr($agent_id); ?>" class="regular-text" required />
            </td>
        </tr>
        <tr>
            <th><label for="userinfo_phone_number"><?php _e('Phone Number', 'userinfo-manager'); ?></label></th>
            <td>
                <input
                    type="text"
                    id="userinfo_phone_number"
                    name="userinfo_phone_number"
                    value="<?php echo esc_attr($phone_number); ?>"
                    class="regular-text"
                    required
                    pattern="[0-9]{10,50}"
                    minlength="10"
                    maxlength="50"
                    title="<?php esc_attr_e('Phone number must be 10-50 digits only', 'userinfo-manager'); ?>"
                />
                <p class="description"><?php _e('Numbers only, 10-50 characters', 'userinfo-manager'); ?></p>
            </td>
        </tr>
        <tr>
            <th><label for="userinfo_nid_number"><?php _e('NID Number', 'userinfo-manager'); ?></label></th>
            <td>
                <input
                    type="text"
                    id="userinfo_nid_number"
                    name="userinfo_nid_number"
                    value="<?php echo esc_attr($nid_number); ?>"
                    class="regular-text"
                    required
                    pattern="[0-9]{10,50}"
                    minlength="10"
                    maxlength="50"
                    title="<?php esc_attr_e('NID number must be 10-50 digits only', 'userinfo-manager'); ?>"
                />
                <p class="description"><?php _e('Numbers only, 10-50 characters', 'userinfo-manager'); ?></p>
            </td>
        </tr>
        <tr>
            <th><label><?php _e('Valid Member', 'userinfo-manager'); ?></label></th>
            <td>
                <div class="userinfo-details-toggle">
                    <label class="userinfo-toggle-switch" data-post-id="<?php echo esc_attr($post->ID); ?>">
                        <input type="checkbox" <?php checked($is_valid, '1'); ?>>
                        <span class="userinfo-toggle-slider"></span>
                    </label>
                    <span class="userinfo-toggle-label <?php echo ($is_valid == '1') ? 'valid' : 'invalid'; ?>">
                        <?php echo ($is_valid == '1') ? __('Valid', 'userinfo-manager') : __('Invalid', 'userinfo-manager'); ?>
                    </span>
                    <p class="description" style="margin: 0 0 0 10px;">
                        <?php _e('Toggle to change member validity status', 'userinfo-manager'); ?>
                    </p>
                </div>
                <!-- Hidden field for form submission fallback -->
                <input type="hidden" id="userinfo_is_valid" name="userinfo_is_valid" value="<?php echo esc_attr($is_valid); ?>" />
            </td>
        </tr>
        <tr>
            <th><label><?php _e('Submitted Date', 'userinfo-manager'); ?></label></th>
            <td>
                <strong><?php echo $submitted_date ? esc_html(date_i18n(get_option('date_format') . ' ' . get_option('time_format'), strtotime($submitted_date))) : __('N/A', 'userinfo-manager'); ?></strong>
            </td>
        </tr>
        <tr>
            <th><label><?php _e('NID Image', 'userinfo-manager'); ?></label></th>
            <td>
                <div id="userinfo-image-container">
                    <?php if ($nid_image_id):
                        $image_url = wp_get_attachment_image_url($nid_image_id, 'medium');
                        $image_full_url = wp_get_attachment_image_url($nid_image_id, 'full');
                        if ($image_url): ?>
                            <div id="current-image-preview">
                                <a href="<?php echo esc_url($image_full_url); ?>" target="_blank">
                                    <img src="<?php echo esc_url($image_url); ?>" alt="<?php _e('User Image', 'userinfo-manager'); ?>" style="max-width: 300px; height: auto; border: 1px solid #ddd; padding: 5px; border-radius: 4px; display: block; margin-bottom: 10px;">
                                </a>
                                <p class="description" style="margin-bottom: 10px;">
                                    <?php _e('Click image to view full size', 'userinfo-manager'); ?>
                                </p>
                                <input type="hidden" name="userinfo_current_image" value="<?php echo esc_attr($nid_image_id); ?>">
                                <button type="button" class="button button-secondary" id="replace-image-btn" style="margin-right: 10px;">
                                    <?php _e('Replace Image', 'userinfo-manager'); ?>
                                </button>
                                <button type="button" class="button button-danger" id="remove-image-btn" style="background: #dc3545; color: white; border-color: #dc3545;">
                                    <?php _e('Remove Image', 'userinfo-manager'); ?>
                                </button>
                                <input type="hidden" name="userinfo_remove_image" id="remove-image-flag" value="0">
                            </div>
                        <?php else: ?>
                            <p><?php _e('Image not found', 'userinfo-manager'); ?></p>
                        <?php endif; ?>
                    <?php else: ?>
                        <p id="no-image-text"><?php _e('No image uploaded', 'userinfo-manager'); ?></p>
                    <?php endif; ?>

                    <div id="upload-image-section" style="<?php echo $nid_image_id ? 'display: none;' : ''; ?> margin-top: 15px;">
                        <input type="file" name="userinfo_new_image" id="userinfo-new-image" accept="image/*" style="margin-bottom: 10px;">
                        <p class="description">
                            <?php _e('Allowed formats: JPG, PNG, GIF (Max 2MB)', 'userinfo-manager'); ?>
                        </p>
                        <div id="new-image-preview" style="display: none; margin-top: 10px;">
                            <img id="new-image-preview-img" src="" alt="Preview" style="max-width: 300px; height: auto; border: 1px solid #ddd; padding: 5px; border-radius: 4px;">
                        </div>
                    </div>
                </div>

                <script>
                    jQuery(document).ready(function($) {
                        // Replace image button
                        $('#replace-image-btn').on('click', function() {
                            $('#current-image-preview').hide();
                            $('#upload-image-section').show();
                        });

                        // Remove image button
                        $('#remove-image-btn').on('click', function() {
                            if (confirm('<?php _e('Are you sure you want to remove this image?', 'userinfo-manager'); ?>')) {
                                $('#remove-image-flag').val('1');
                                $('#current-image-preview').hide();
                                $('#no-image-text').remove();
                                $('#userinfo-image-container').prepend('<p id="no-image-text" style="color: #d63638;"><?php _e('Image will be removed when you update this post.', 'userinfo-manager'); ?></p>');
                                $('#upload-image-section').show();
                            }
                        });

                        // Preview new image
                        $('#userinfo-new-image').on('change', function(e) {
                            var file = e.target.files[0];
                            if (file) {
                                // Validate file size (2MB)
                                if (file.size > 2 * 1024 * 1024) {
                                    alert('<?php _e('File size must be less than 2MB', 'userinfo-manager'); ?>');
                                    $(this).val('');
                                    return;
                                }

                                // Validate file type
                                if (!file.type.match('image.*')) {
                                    alert('<?php _e('Please upload an image file', 'userinfo-manager'); ?>');
                                    $(this).val('');
                                    return;
                                }

                                // Show preview
                                var reader = new FileReader();
                                reader.onload = function(e) {
                                    $('#new-image-preview-img').attr('src', e.target.result);
                                    $('#new-image-preview').show();
                                };
                                reader.readAsDataURL(file);
                            } else {
                                $('#new-image-preview').hide();
                            }
                        });
                    });
                </script>
            </td>
        </tr>
    </table>
    <?php
}

/**
 * Save meta box data
 */
function userinfo_save_meta_box_data($post_id) {
    // Check if nonce is set
    if (!isset($_POST['userinfo_meta_box_nonce'])) {
        return;
    }

    // Verify nonce
    if (!wp_verify_nonce($_POST['userinfo_meta_box_nonce'], 'userinfo_save_meta_box_data')) {
        return;
    }

    // Check if this is an autosave
    if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) {
        return;
    }

    // Check user permissions
    if (!current_user_can('edit_post', $post_id)) {
        return;
    }

    // Save full name field
    if (isset($_POST['userinfo_full_name'])) {
        $full_name = sanitize_text_field($_POST['userinfo_full_name']);
        update_post_meta($post_id, '_userinfo_full_name', $full_name);
    }

    // Save username field
    if (isset($_POST['userinfo_username'])) {
        $username = sanitize_text_field($_POST['userinfo_username']);
        update_post_meta($post_id, '_userinfo_username', $username);
    }

    // Save agent ID field
    if (isset($_POST['userinfo_agent_id'])) {
        $agent_id = sanitize_text_field($_POST['userinfo_agent_id']);
        update_post_meta($post_id, '_userinfo_agent_id', $agent_id);
    }

    // Save phone number field with validation
    if (isset($_POST['userinfo_phone_number'])) {
        $phone_number = sanitize_text_field($_POST['userinfo_phone_number']);

        // Validate phone number: must be numeric and 10-50 characters
        if (!empty($phone_number) && (!ctype_digit($phone_number) || strlen($phone_number) < 10 || strlen($phone_number) > 50)) {
            add_settings_error(
                'userinfo_messages',
                'userinfo_message',
                __('Phone number must be 10-50 digits only.', 'userinfo-manager'),
                'error'
            );
        } else {
            update_post_meta($post_id, '_userinfo_phone_number', $phone_number);
        }
    }

    // Save NID number field with validation
    if (isset($_POST['userinfo_nid_number'])) {
        $nid_number = sanitize_text_field($_POST['userinfo_nid_number']);

        // Validate NID number: must be numeric and 10-50 characters
        if (!empty($nid_number) && (!ctype_digit($nid_number) || strlen($nid_number) < 10 || strlen($nid_number) > 50)) {
            add_settings_error(
                'userinfo_messages',
                'userinfo_message',
                __('NID number must be 10-50 digits only.', 'userinfo-manager'),
                'error'
            );
        } else {
            update_post_meta($post_id, '_userinfo_nid_number', $nid_number);
        }
    }

    // Save valid member toggle (checkbox)
    // Checkboxes are only sent when checked, so we need to handle both cases
    $is_valid = isset($_POST['userinfo_is_valid']) ? '1' : '0';
    update_post_meta($post_id, '_userinfo_is_valid', $is_valid);

    // Handle NID image removal
    if (isset($_POST['userinfo_remove_image']) && $_POST['userinfo_remove_image'] == '1') {
        $current_image_id = get_post_meta($post_id, '_userinfo_nid_image', true);
        if ($current_image_id) {
            // Delete the attachment
            wp_delete_attachment($current_image_id, true);
            // Remove the meta
            delete_post_meta($post_id, '_userinfo_nid_image');
        }
    }

    // Handle new image upload (replace or new)
    if (isset($_FILES['userinfo_new_image']) && $_FILES['userinfo_new_image']['error'] === UPLOAD_ERR_OK) {
        require_once(ABSPATH . 'wp-admin/includes/file.php');
        require_once(ABSPATH . 'wp-admin/includes/media.php');
        require_once(ABSPATH . 'wp-admin/includes/image.php');

        // If replacing, delete old image first
        if (isset($_POST['userinfo_current_image']) && !empty($_POST['userinfo_current_image'])) {
            $old_image_id = intval($_POST['userinfo_current_image']);
            wp_delete_attachment($old_image_id, true);
        }

        // Upload new image
        $attachment_id = media_handle_upload('userinfo_new_image', $post_id);

        if (!is_wp_error($attachment_id)) {
            update_post_meta($post_id, '_userinfo_nid_image', $attachment_id);

            // Store success message in transient
            set_transient('userinfo_admin_notice_' . $post_id, array(
                'type' => 'success',
                'message' => __('Image uploaded successfully!', 'userinfo-manager')
            ), 30);
        } else {
            // Store error message in transient
            set_transient('userinfo_admin_notice_' . $post_id, array(
                'type' => 'error',
                'message' => __('Image upload failed: ', 'userinfo-manager') . $attachment_id->get_error_message()
            ), 30);
        }
    } elseif (isset($_FILES['userinfo_new_image']) && $_FILES['userinfo_new_image']['error'] !== UPLOAD_ERR_NO_FILE) {
        // Handle upload errors
        $upload_errors = array(
            UPLOAD_ERR_INI_SIZE => __('The uploaded file exceeds the upload_max_filesize directive in php.ini.', 'userinfo-manager'),
            UPLOAD_ERR_FORM_SIZE => __('The uploaded file exceeds the MAX_FILE_SIZE directive.', 'userinfo-manager'),
            UPLOAD_ERR_PARTIAL => __('The uploaded file was only partially uploaded.', 'userinfo-manager'),
            UPLOAD_ERR_NO_TMP_DIR => __('Missing a temporary folder.', 'userinfo-manager'),
            UPLOAD_ERR_CANT_WRITE => __('Failed to write file to disk.', 'userinfo-manager'),
            UPLOAD_ERR_EXTENSION => __('A PHP extension stopped the file upload.', 'userinfo-manager'),
        );

        $error_message = isset($upload_errors[$_FILES['userinfo_new_image']['error']])
            ? $upload_errors[$_FILES['userinfo_new_image']['error']]
            : __('Unknown upload error.', 'userinfo-manager');

        set_transient('userinfo_admin_notice_' . $post_id, array(
            'type' => 'error',
            'message' => __('Image upload failed: ', 'userinfo-manager') . $error_message
        ), 30);
    }
}

/**
 * Display admin notices for image upload
 */
function userinfo_display_admin_notices() {
    global $post;

    if ($post && $post->post_type == 'userinfo') {
        // Display transient notices (for image upload success/errors)
        $notice = get_transient('userinfo_admin_notice_' . $post->ID);

        if ($notice && is_array($notice)) {
            $class = $notice['type'] == 'success' ? 'notice-success' : 'notice-error';
            ?>
            <div class="notice <?php echo esc_attr($class); ?> is-dismissible">
                <p><?php echo esc_html($notice['message']); ?></p>
            </div>
            <?php

            // Delete transient after displaying
            delete_transient('userinfo_admin_notice_' . $post->ID);
        }

        // Display settings errors (for validation errors)
        settings_errors('userinfo_messages');
    }
}
add_action('admin_notices', 'userinfo_display_admin_notices');
add_action('save_post', 'userinfo_save_meta_box_data');

/**
 * Frontend form handler
 */
function userinfo_handle_form_submission() {
    // Check if form was submitted
    if (!isset($_POST['userinfo_submit']) || !isset($_POST['userinfo_nonce'])) {
        return;
    }

    // Verify nonce
    if (!wp_verify_nonce($_POST['userinfo_nonce'], 'userinfo_form_submit')) {
        wp_die(__('Security check failed. Please try again.', 'userinfo-manager'));
    }

    // Validate and sanitize inputs
    $errors = array();

    $full_name = isset($_POST['userinfo_full_name']) ? sanitize_text_field($_POST['userinfo_full_name']) : '';
    $username = isset($_POST['userinfo_username']) ? sanitize_text_field($_POST['userinfo_username']) : '';
    $agent_id = isset($_POST['userinfo_agent_id']) ? sanitize_text_field($_POST['userinfo_agent_id']) : '';
    $phone_number = isset($_POST['userinfo_phone_number']) ? sanitize_text_field($_POST['userinfo_phone_number']) : '';
    $nid_number = isset($_POST['userinfo_nid_number']) ? sanitize_text_field($_POST['userinfo_nid_number']) : '';

    // Validation
    if (empty($full_name)) {
        $errors[] = __('Full Name is required.', 'userinfo-manager');
    }

    if (empty($username)) {
        $errors[] = __('Username is required.', 'userinfo-manager');
    }

    if (empty($agent_id)) {
        $errors[] = __('Agent ID is required.', 'userinfo-manager');
    }

    if (empty($phone_number)) {
        $errors[] = __('Phone Number is required.', 'userinfo-manager');
    } elseif (!ctype_digit($phone_number) || strlen($phone_number) < 10 || strlen($phone_number) > 50) {
        $errors[] = __('Phone Number must be 10-50 digits only.', 'userinfo-manager');
    }

    if (empty($nid_number)) {
        $errors[] = __('NID Number is required.', 'userinfo-manager');
    } elseif (!ctype_digit($nid_number) || strlen($nid_number) < 10 || strlen($nid_number) > 50) {
        $errors[] = __('NID Number must be 10-50 digits only.', 'userinfo-manager');
    }

    // Validate NID image is required and uploaded
    if (!isset($_FILES['userinfo_nid_image']) || $_FILES['userinfo_nid_image']['error'] !== UPLOAD_ERR_OK) {
        $errors[] = __('NID Image is required.', 'userinfo-manager');
    }

    // Validate NID image if uploaded
    $image_attachment_id = 0;
    if (isset($_FILES['userinfo_nid_image']) && $_FILES['userinfo_nid_image']['error'] === UPLOAD_ERR_OK) {
        $file = $_FILES['userinfo_nid_image'];

        // Validate file size (2MB)
        if ($file['size'] > 2 * 1024 * 1024) {
            $errors[] = __('NID Image file size must be less than 2MB.', 'userinfo-manager');
        }

        // Validate file type
        $allowed_types = array('image/jpeg', 'image/jpg', 'image/png', 'image/gif');
        $file_type = wp_check_filetype($file['name']);

        if (!in_array($file['type'], $allowed_types)) {
            $errors[] = __('Only JPG, PNG, and GIF images are allowed for NID Image.', 'userinfo-manager');
        }
    }

    // Check if Agent ID already submitted this month
    $current_month_start = date('Y-m-01 00:00:00');
    $current_month_end = date('Y-m-t 23:59:59');

    $existing_submission = new WP_Query(array(
        'post_type' => 'userinfo',
        'post_status' => 'publish',
        'meta_query' => array(
            array(
                'key' => '_userinfo_agent_id',
                'value' => $agent_id,
                'compare' => '='
            )
        ),
        'date_query' => array(
            array(
                'after' => $current_month_start,
                'before' => $current_month_end,
                'inclusive' => true
            )
        ),
        'posts_per_page' => 1
    ));

    if ($existing_submission->have_posts()) {
        $errors[] = __('You have already submitted this month. Each Agent ID can only submit once per month.', 'userinfo-manager');
        wp_reset_postdata();
    }

    // If there are errors, store them in session and redirect back
    if (!empty($errors)) {
        set_transient('userinfo_errors_' . session_id(), $errors, 45);
        wp_safe_redirect(wp_get_referer());
        exit;
    }

    // Create new UserInfo post
    $post_data = array(
        'post_title'    => $full_name . ' - ' . $agent_id,
        'post_type'     => 'userinfo',
        'post_status'   => 'publish',
    );

    $post_id = wp_insert_post($post_data);

    if ($post_id && !is_wp_error($post_id)) {
        // Save meta data
        update_post_meta($post_id, '_userinfo_full_name', $full_name);
        update_post_meta($post_id, '_userinfo_username', $username);
        update_post_meta($post_id, '_userinfo_agent_id', $agent_id);
        update_post_meta($post_id, '_userinfo_phone_number', $phone_number);
        update_post_meta($post_id, '_userinfo_nid_number', $nid_number);
        update_post_meta($post_id, '_userinfo_submitted_date', current_time('mysql'));
        update_post_meta($post_id, '_userinfo_is_valid', '1'); // Default to valid

        // Handle NID image upload
        if (isset($_FILES['userinfo_nid_image']) && $_FILES['userinfo_nid_image']['error'] === UPLOAD_ERR_OK) {
            require_once(ABSPATH . 'wp-admin/includes/file.php');
            require_once(ABSPATH . 'wp-admin/includes/media.php');
            require_once(ABSPATH . 'wp-admin/includes/image.php');

            $attachment_id = media_handle_upload('userinfo_nid_image', $post_id);

            if (!is_wp_error($attachment_id)) {
                update_post_meta($post_id, '_userinfo_nid_image', $attachment_id);
            }
        }

        // Set success message
        set_transient('userinfo_success_' . session_id(), __('Your information has been submitted successfully!', 'userinfo-manager'), 45);

        // Redirect back
        wp_safe_redirect(wp_get_referer());
        exit;
    } else {
        set_transient('userinfo_errors_' . session_id(), array(__('Failed to submit information. Please try again.', 'userinfo-manager')), 45);
        wp_safe_redirect(wp_get_referer());
        exit;
    }
}
add_action('admin_post_nopriv_userinfo_submit', 'userinfo_handle_form_submission');
add_action('admin_post_userinfo_submit', 'userinfo_handle_form_submission');

/**
 * Initialize session for messages
 */
function userinfo_init_session() {
    if (!session_id()) {
        session_start();
    }
}
add_action('init', 'userinfo_init_session');

/**
 * Frontend form shortcode
 */
function userinfo_form_shortcode($atts) {
    ob_start();

    // Get messages from transients
    $errors = get_transient('userinfo_errors_' . session_id());
    $success = get_transient('userinfo_success_' . session_id());

    // Delete transients after retrieving
    if ($errors) {
        delete_transient('userinfo_errors_' . session_id());
    }
    if ($success) {
        delete_transient('userinfo_success_' . session_id());
    }

    ?>
    <div class="userinfo-form-container">
        <?php if ($success): ?>
            <div class="userinfo-success">
                <?php echo esc_html($success); ?>
            </div>
        <?php endif; ?>

        <?php if ($errors && is_array($errors)): ?>
            <div class="userinfo-errors">
                <ul>
                    <?php foreach ($errors as $error): ?>
                        <li><?php echo esc_html($error); ?></li>
                    <?php endforeach; ?>
                </ul>
            </div>
        <?php endif; ?>

        <form method="post" action="<?php echo esc_url(admin_url('admin-post.php')); ?>" class="userinfo-form" enctype="multipart/form-data">
            <?php wp_nonce_field('userinfo_form_submit', 'userinfo_nonce'); ?>
            <input type="hidden" name="action" value="userinfo_submit">

            <div class="form-group">
                <label for="userinfo_full_name">
                    <?php _e('Full Name', 'userinfo-manager'); ?> <span style="color: red;">*</span>
                </label>
                <input
                    type="text"
                    id="userinfo_full_name"
                    name="userinfo_full_name"
                    placeholder="আপনার নাম লিখুন"
                    required
                    value="<?php echo isset($_POST['userinfo_full_name']) ? esc_attr($_POST['userinfo_full_name']) : ''; ?>"
                />
            </div>

            <div class="form-group">
                <label for="userinfo_username">
                    <?php _e('Username', 'userinfo-manager'); ?> <span style="color: red;">*</span>
                </label>
                <input
                    type="text"
                    id="userinfo_username"
                    name="userinfo_username"
                    placeholder="আপনার ইউজার নেম লিখুন"
                    required
                    value="<?php echo isset($_POST['userinfo_username']) ? esc_attr($_POST['userinfo_username']) : ''; ?>"
                />
            </div>

            <div class="form-group">
                <label for="userinfo_agent_id">
                    <?php _e('Agent ID', 'userinfo-manager'); ?> <span style="color: red;">*</span>
                </label>
                <input
                    type="text"
                    id="userinfo_agent_id"
                    name="userinfo_agent_id"
                    placeholder="এজেন্ট আইডি নাম্বার লিখুন"
                    required
                    value="<?php echo isset($_POST['userinfo_agent_id']) ? esc_attr($_POST['userinfo_agent_id']) : ''; ?>"
                />
            </div>

            <div class="form-group">
                <label for="userinfo_phone_number">
                    <?php _e('Phone Number', 'userinfo-manager'); ?> <span style="color: red;">*</span>
                    <span class="info-icon" data-tooltip="<?php esc_attr_e('Numbers only, 10-50 characters', 'userinfo-manager'); ?>">ℹ️</span>
                </label>
                <input
                    type="text"
                    id="userinfo_phone_number"
                    name="userinfo_phone_number"
                    placeholder="আপনার মোবাইল নাম্বার লিখুন"
                    required
                    pattern="[0-9]{10,50}"
                    minlength="10"
                    maxlength="50"
                    value="<?php echo isset($_POST['userinfo_phone_number']) ? esc_attr($_POST['userinfo_phone_number']) : ''; ?>"
                    title="<?php esc_attr_e('Phone number must be 10-50 digits only', 'userinfo-manager'); ?>"
                />
            </div>

            <div class="form-group full-width">
                <label for="userinfo_nid_number">
                    <?php _e('NID Number', 'userinfo-manager'); ?> <span style="color: red;">*</span>
                    <span class="info-icon" data-tooltip="<?php esc_attr_e('Numbers only, 10-50 characters', 'userinfo-manager'); ?>">ℹ️</span>
                </label>
                <input
                    type="text"
                    id="userinfo_nid_number"
                    name="userinfo_nid_number"
                    placeholder="আপনার এনআইডি নাম্বার লিখুন"
                    required
                    pattern="[0-9]{10,50}"
                    minlength="10"
                    maxlength="50"
                    value="<?php echo isset($_POST['userinfo_nid_number']) ? esc_attr($_POST['userinfo_nid_number']) : ''; ?>"
                    title="<?php esc_attr_e('NID number must be 10-50 digits only', 'userinfo-manager'); ?>"
                />
            </div>

            <div class="form-group full-width">
                <label for="userinfo_nid_image">
                    <?php _e('NID Image', 'userinfo-manager'); ?> <span style="color: red;">*</span>
                    <span class="info-icon" data-tooltip="<?php esc_attr_e('Allowed formats: JPG, PNG, GIF (Max 2MB)', 'userinfo-manager'); ?>">ℹ️</span>
                </label>

                <!-- Custom File Upload Area -->
                <div class="custom-file-upload-wrapper">
                    <input
                        type="file"
                        id="userinfo_nid_image"
                        name="userinfo_nid_image"
                        accept="image/*"
                        required
                        class="hidden-file-input"
                    />
                    <label for="userinfo_nid_image" class="custom-file-label">
                        <div class="upload-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M17 8L12 3L7 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 3V15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="upload-text">
                            <span class="upload-title-bengali"><?php _e('আপনার এনআইডি ছবি আপলোড করেন', 'userinfo-manager'); ?></span>
                            <span class="upload-title"><?php _e('Click to upload', 'userinfo-manager'); ?></span>
                            <span class="upload-subtitle"><?php _e('or drag and drop', 'userinfo-manager'); ?></span>
                            <span class="upload-format"><?php _e('JPG, PNG or GIF (max. 2MB)', 'userinfo-manager'); ?></span>
                        </div>
                    </label>
                </div>

                <!-- Preview Area -->
                <div id="image-preview" class="image-preview-container">
                    <div class="preview-inner">
                        <img id="preview-img" src="" alt="Preview" />
                        <button type="button" id="remove-image" class="remove-image-btn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <?php _e('Remove', 'userinfo-manager'); ?>
                        </button>
                    </div>
                </div>
            </div>

            <div class="form-group full-width">
                <button type="submit" name="userinfo_submit">
                    <span><?php _e('Submit', 'userinfo-manager'); ?></span>
                </button>
            </div>
        </form>
    </div>

    <style>
        /* ========================================
           GLASSMORPHISM DESIGN SYSTEM
           Modern, clean, and professional styling
        ======================================== */

        /* Animated Gradient Background */
        .userinfo-form-container {
            position: relative;
            max-width: 650px;
            margin: 40px auto;
            padding: 0;
            border-radius: 20px;
            overflow: hidden;
            isolation: isolate;
        }

        .userinfo-form-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            right: -50%;
            bottom: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(135deg,
                #667eea 0%,
                #764ba2 25%,
                #f093fb 50%,
                #4facfe 75%,
                #00f2fe 100%
            );
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            z-index: -1;
            opacity: 0.15;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Glassmorphism Form Card */
        .userinfo-form {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            padding: 40px;
            box-shadow:
                0 8px 32px 0 rgba(31, 38, 135, 0.15),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            isolation: isolate;
        }

        .userinfo-form::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: shimmer 8s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes shimmer {
            0%, 100% { transform: translate(0, 0); opacity: 0.3; }
            50% { transform: translate(-30%, -30%); opacity: 0.5; }
        }

        .userinfo-form:hover {
            box-shadow:
                0 12px 40px 0 rgba(31, 38, 135, 0.2),
                0 0 0 1px rgba(255, 255, 255, 0.2) inset;
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Form Group Styling */
        .form-group {
            margin-bottom: 28px !important;
            position: relative;
            animation: slideInUp 0.6s ease-out backwards;
        }

        .form-group:nth-child(1) { animation-delay: 0.1s; }
        .form-group:nth-child(2) { animation-delay: 0.15s; }
        .form-group:nth-child(3) { animation-delay: 0.2s; }
        .form-group:nth-child(4) { animation-delay: 0.25s; }
        .form-group:nth-child(5) { animation-delay: 0.3s; }
        .form-group:nth-child(6) { animation-delay: 0.35s; }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Label Styling */
        .form-group label {
            display: block !important;
            margin-bottom: 10px !important;
            font-weight: 600 !important;
            font-size: 14px !important;
            color: #2d3748 !important;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Input Field Styling */
        .userinfo-form input[type="text"],
        .userinfo-form input[type="file"] {
            width: 100% !important;
            padding: 14px 18px !important;
            border: 2px solid rgba(255, 255, 255, 0.3) !important;
            border-radius: 12px !important;
            font-size: 15px !important;
            background: rgba(255, 255, 255, 0.5) !important;
            backdrop-filter: blur(10px) !important;
            -webkit-backdrop-filter: blur(10px) !important;
            color: #2d3748 !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05) !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .userinfo-form input::placeholder {
            color: #718096;
            opacity: 0.7;
        }

        .userinfo-form input:focus {
            outline: none !important;
            border-color: rgba(102, 126, 234, 0.8) !important;
            background: rgba(255, 255, 255, 0.7) !important;
            box-shadow:
                0 4px 16px rgba(102, 126, 234, 0.15) !important,
                0 0 0 3px rgba(102, 126, 234, 0.1) !important;
            transform: translateY(-2px);
        }

        .userinfo-form input:hover:not(:focus) {
            border-color: rgba(255, 255, 255, 0.5) !important;
            background: rgba(255, 255, 255, 0.6) !important;
        }

        /* Submit Button Styling */
        .userinfo-form button[type="submit"] {
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
            margin-top: 12px;
        }

        .userinfo-form button[type="submit"]::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .userinfo-form button[type="submit"]:hover::before {
            left: 100%;
        }

        .userinfo-form button[type="submit"]:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .userinfo-form button[type="submit"]:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        /* Image Preview Glassmorphism */
        #image-preview {
            margin-top: 20px !important;
            padding: 20px;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        #preview-img {
            max-width: 100% !important;
            max-height: 300px !important;
            border-radius: 12px !important;
            border: 3px solid rgba(255, 255, 255, 0.6) !important;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15) !important;
            display: block;
            margin: 0 auto;
            transition: transform 0.3s ease;
        }

        #preview-img:hover {
            transform: scale(1.02);
        }

        #remove-image {
            display: block !important;
            margin: 15px auto 0 !important;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
            color: white !important;
            padding: 10px 24px !important;
            border: none !important;
            border-radius: 10px !important;
            cursor: pointer !important;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
        }

        #remove-image:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4);
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%) !important;
        }

        /* Success/Error Messages Glassmorphism */
        .userinfo-success,
        .userinfo-errors {
            background: rgba(255, 255, 255, 0.4) !important;
            backdrop-filter: blur(15px) !important;
            -webkit-backdrop-filter: blur(15px) !important;
            border-radius: 12px !important;
            padding: 16px 20px !important;
            margin-bottom: 24px !important;
            animation: slideInDown 0.5s ease-out;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .userinfo-success {
            border: 2px solid rgba(72, 187, 120, 0.5) !important;
            color: #22543d !important;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.2);
        }

        .userinfo-errors {
            border: 2px solid rgba(245, 87, 108, 0.5) !important;
            color: #742a2a !important;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.2);
        }

        .userinfo-errors ul {
            margin: 8px 0 0 0 !important;
            padding-left: 24px !important;
        }

        .userinfo-errors li {
            margin: 4px 0;
            font-weight: 500;
        }

        /* Info Icon Tooltip with Glassmorphism */
        .info-icon {
            display: inline-block;
            margin-left: 8px;
            cursor: help;
            font-size: 16px;
            position: relative;
            vertical-align: middle;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .info-icon:hover {
            transform: scale(1.15) rotate(5deg);
        }

        .info-icon::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%) translateY(-5px);
            background: rgba(45, 55, 72, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: #ffffff;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-weight: 500;
        }

        .info-icon::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(3px);
            border: 7px solid transparent;
            border-top-color: rgba(45, 55, 72, 0.95);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1001;
        }

        .info-icon:hover::after {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-10px);
        }

        .info-icon:hover::before {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-2px);
        }

        /* ========================================
           CUSTOM FILE UPLOAD DESIGN
           Modern drag-and-drop style interface
        ======================================== */

        /* Hide native file input */
        .hidden-file-input {
            position: absolute;
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            z-index: -1;
        }

        /* Custom File Upload Wrapper */
        .custom-file-upload-wrapper {
            margin-bottom: 20px;
            position: relative;
            z-index: 5;
        }

        /* Custom Upload Label (Clickable Area) */
        .custom-file-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 24px;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 2px dashed rgba(102, 126, 234, 0.4);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .custom-file-label::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .custom-file-label:hover {
            border-color: rgba(102, 126, 234, 0.8);
            background: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
        }

        .custom-file-label:hover::before {
            opacity: 1;
        }

        .custom-file-label:active {
            transform: translateY(0);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.1);
        }

        /* Upload Icon */
        .upload-icon {
            width: 64px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            margin: 0 auto 20px auto;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .custom-file-label:hover .upload-icon {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .upload-icon svg {
            width: 32px;
            height: 32px;
        }

        /* Upload Text */
        .upload-text {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            text-align: center;
        }

        .upload-title-bengali {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .upload-title {
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
            letter-spacing: 0.3px;
        }

        .upload-subtitle {
            font-size: 14px;
            color: #718096;
            font-weight: 400;
        }

        .upload-format {
            font-size: 12px;
            color: #a0aec0;
            margin-top: 4px;
            font-weight: 400;
        }

        /* Drag Active State */
        .custom-file-label.drag-active {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.15);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.25);
        }

        .custom-file-label.drag-active .upload-icon {
            transform: scale(1.15) rotate(10deg);
            box-shadow: 0 6px 18px rgba(102, 126, 234, 0.5);
        }

        .custom-file-label.drag-active .upload-text {
            color: #667eea;
        }

        /* Image Preview Container */
        .image-preview-container {
            display: none;
            margin-top: 20px;
            animation: fadeIn 0.4s ease-out;
        }

        .image-preview-container.active {
            display: block;
        }

        .preview-inner {
            position: relative;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }

        #preview-img {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 12px;
            border: 3px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            display: block;
            transition: transform 0.3s ease;
        }

        #preview-img:hover {
            transform: scale(1.02);
        }

        /* Remove Button */
        .remove-image-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 16px auto 0;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
        }

        .remove-image-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4);
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
        }

        .remove-image-btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
        }

        .remove-image-btn svg {
            width: 18px;
            height: 18px;
        }

        /* File Input Focus State (for accessibility) */
        .hidden-file-input:focus + .custom-file-label {
            outline: 3px solid rgba(102, 126, 234, 0.4);
            outline-offset: 2px;
            border-color: rgba(102, 126, 234, 0.8);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .custom-file-label {
                padding: 32px 20px;
            }

            .upload-icon {
                width: 56px;
                height: 56px;
                margin: 0 auto 18px auto;
            }

            .upload-icon svg {
                width: 28px;
                height: 28px;
            }

            .upload-title {
                font-size: 15px;
            }

            .upload-subtitle {
                font-size: 13px;
            }

            .upload-format {
                font-size: 11px;
            }

            #preview-img {
                max-height: 300px;
            }
        }

        @media (max-width: 480px) {
            .custom-file-label {
                padding: 28px 16px;
            }

            .upload-icon {
                width: 48px;
                height: 48px;
                margin: 0 auto 16px auto;
            }

            .upload-icon svg {
                width: 24px;
                height: 24px;
            }

            .upload-title {
                font-size: 14px;
            }

            .upload-subtitle {
                font-size: 12px;
            }

            #preview-img {
                max-height: 250px;
            }

            .remove-image-btn {
                padding: 10px 20px;
                font-size: 13px;
            }
        }

        /* Required Asterisk Styling */
        .form-group label span[style*="red"] {
            color: #f5576c !important;
            font-size: 16px;
            margin-left: 4px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .userinfo-form-container {
                margin: 20px auto;
            }

            .userinfo-form {
                padding: 30px 24px;
                border-radius: 16px;
            }

            .form-group {
                margin-bottom: 24px !important;
            }

            .info-icon::after {
                left: auto;
                right: 0;
                transform: translateX(0) translateY(-5px);
                white-space: normal;
                max-width: 220px;
            }

            .info-icon::before {
                left: auto;
                right: 14px;
                transform: translateX(0) translateY(3px);
            }

            .info-icon:hover::after {
                transform: translateX(0) translateY(-10px);
            }

            .info-icon:hover::before {
                transform: translateX(0) translateY(-2px);
            }
        }

        @media (max-width: 480px) {
            .userinfo-form {
                padding: 24px 18px;
            }

            .userinfo-form input[type="text"],
            .userinfo-form input[type="file"] {
                padding: 12px 14px !important;
                font-size: 14px !important;
            }

            .userinfo-form button[type="submit"] {
                padding: 14px 20px;
                font-size: 15px;
            }

            .form-group label {
                font-size: 13px !important;
            }

            .upload-title-bengali {
                font-size: 16px;
                margin-bottom: 6px;
            }

            .upload-title {
                font-size: 14px;
            }

            .upload-subtitle {
                font-size: 13px;
            }
        }

        /* Loading State Animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .userinfo-form.loading {
            pointer-events: none;
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Focus Ring for Accessibility */
        .userinfo-form *:focus-visible {
            outline: 3px solid rgba(102, 126, 234, 0.4);
            outline-offset: 2px;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const imageInput = document.getElementById('userinfo_nid_image');
            const uploadWrapper = document.querySelector('.custom-file-upload-wrapper');
            const uploadLabel = document.querySelector('.custom-file-label');
            const imagePreview = document.getElementById('image-preview');
            const previewImg = document.getElementById('preview-img');
            const removeBtn = document.getElementById('remove-image');

            // File validation function
            function validateFile(file) {
                // Validate file size (2MB)
                if (file.size > 2 * 1024 * 1024) {
                    alert('<?php _e('File size must be less than 2MB', 'userinfo-manager'); ?>');
                    return false;
                }

                // Validate file type
                if (!file.type.match('image.*')) {
                    alert('<?php _e('Please upload an image file', 'userinfo-manager'); ?>');
                    return false;
                }

                return true;
            }

            // Show preview function
            function showPreview(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    uploadWrapper.style.display = 'none';
                    imagePreview.classList.add('active');
                };
                reader.readAsDataURL(file);
            }

            // File input change event
            if (imageInput) {
                imageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];

                    if (file) {
                        if (validateFile(file)) {
                            showPreview(file);
                        } else {
                            imageInput.value = '';
                        }
                    }
                });

                // Drag and drop events
                if (uploadLabel) {
                    // Prevent default drag behaviors
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                        uploadLabel.addEventListener(eventName, preventDefaults, false);
                        document.body.addEventListener(eventName, preventDefaults, false);
                    });

                    function preventDefaults(e) {
                        e.preventDefault();
                        e.stopPropagation();
                    }

                    // Highlight drop zone
                    ['dragenter', 'dragover'].forEach(eventName => {
                        uploadLabel.addEventListener(eventName, function() {
                            uploadLabel.classList.add('drag-active');
                        }, false);
                    });

                    ['dragleave', 'drop'].forEach(eventName => {
                        uploadLabel.addEventListener(eventName, function() {
                            uploadLabel.classList.remove('drag-active');
                        }, false);
                    });

                    // Handle dropped files
                    uploadLabel.addEventListener('drop', function(e) {
                        const dt = e.dataTransfer;
                        const files = dt.files;

                        if (files.length > 0) {
                            const file = files[0];

                            if (validateFile(file)) {
                                // Manually set the file to the input
                                const dataTransfer = new DataTransfer();
                                dataTransfer.items.add(file);
                                imageInput.files = dataTransfer.files;

                                showPreview(file);
                            }
                        }
                    }, false);
                }

                // Remove button click event
                if (removeBtn) {
                    removeBtn.addEventListener('click', function() {
                        imageInput.value = '';
                        previewImg.src = '';
                        imagePreview.classList.remove('active');
                        uploadWrapper.style.display = 'block';
                    });
                }
            }
        });
    </script>
    <?php

    return ob_get_clean();
}
add_shortcode('userinfo_form', 'userinfo_form_shortcode');

/**
 * Add custom columns to admin list
 */
function userinfo_custom_columns($columns) {
    $new_columns = array(
        'cb' => $columns['cb'],
        'nid_image' => __('NID Image', 'userinfo-manager'),
        'title' => __('Full Name', 'userinfo-manager'),
        'agent_id' => __('Agent ID', 'userinfo-manager'),
        'phone_number' => __('Phone', 'userinfo-manager'),
        'nid_number' => __('NID Number', 'userinfo-manager'),
        'is_valid' => __('Valid', 'userinfo-manager'),
        'submitted_date' => __('Submitted Date', 'userinfo-manager'),
        'date' => $columns['date']
    );
    return $new_columns;
}
add_filter('manage_userinfo_posts_columns', 'userinfo_custom_columns');

/**
 * Populate custom columns
 */
function userinfo_custom_column_content($column, $post_id) {
    switch ($column) {
        case 'nid_image':
            $image_id = get_post_meta($post_id, '_userinfo_nid_image', true);
            if ($image_id) {
                $image_url = wp_get_attachment_image_url($image_id, 'thumbnail');
                if ($image_url) {
                    echo '<img src="' . esc_url($image_url) . '" alt="' . __('NID Image', 'userinfo-manager') . '" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd;">';
                } else {
                    echo '<span style="color: #999;">—</span>';
                }
            } else {
                echo '<span style="color: #999;">—</span>';
            }
            break;
        case 'agent_id':
            $agent_id = get_post_meta($post_id, '_userinfo_agent_id', true);
            echo esc_html($agent_id);
            break;
        case 'phone_number':
            $phone_number = get_post_meta($post_id, '_userinfo_phone_number', true);
            echo esc_html($phone_number);
            break;
        case 'nid_number':
            $nid_number = get_post_meta($post_id, '_userinfo_nid_number', true);
            echo esc_html($nid_number);
            break;
        case 'is_valid':
            $is_valid = get_post_meta($post_id, '_userinfo_is_valid', true);
            // Default to valid if not set
            if ($is_valid === '') {
                $is_valid = '1';
            }

            $checked = ($is_valid == '1') ? 'checked' : '';
            $label_class = ($is_valid == '1') ? 'valid' : 'invalid';
            $label_text = ($is_valid == '1') ? __('Valid', 'userinfo-manager') : __('Invalid', 'userinfo-manager');

            echo '<label class="userinfo-toggle-switch" data-post-id="' . esc_attr($post_id) . '">';
            echo '<input type="checkbox" ' . $checked . '>';
            echo '<span class="userinfo-toggle-slider"></span>';
            echo '</label>';
            echo '<span class="userinfo-toggle-label ' . $label_class . '">' . $label_text . '</span>';
            break;
        case 'submitted_date':
            $submitted_date = get_post_meta($post_id, '_userinfo_submitted_date', true);
            if ($submitted_date) {
                echo esc_html(date_i18n(get_option('date_format') . ' ' . get_option('time_format'), strtotime($submitted_date)));
            } else {
                echo __('N/A', 'userinfo-manager');
            }
            break;
    }
}
add_action('manage_userinfo_posts_custom_column', 'userinfo_custom_column_content', 10, 2);

/**
 * Make email column sortable
 */
function userinfo_sortable_columns($columns) {
    $columns['email'] = 'email';
    $columns['submitted_date'] = 'submitted_date';
    return $columns;
}
add_filter('manage_edit-userinfo_sortable_columns', 'userinfo_sortable_columns');

/**
 * Add month filter dropdown to admin
 */
function userinfo_add_month_filter() {
    global $typenow;

    if ($typenow !== 'userinfo') {
        return;
    }

    global $wpdb;

    // Get all unique months with submissions
    $months = $wpdb->get_results("
        SELECT DISTINCT YEAR(meta_value) as year, MONTH(meta_value) as month
        FROM {$wpdb->postmeta}
        WHERE meta_key = '_userinfo_submitted_date'
        AND meta_value != ''
        ORDER BY meta_value DESC
    ");

    if (empty($months)) {
        return;
    }

    $selected_month = isset($_GET['userinfo_month']) ? sanitize_text_field($_GET['userinfo_month']) : '';

    // Get min and max months for calendar range
    $min_month = '';
    $max_month = '';
    if (!empty($months)) {
        $last_month = end($months);
        $first_month = reset($months);
        $min_month = sprintf('%04d-%02d', $last_month->year, $last_month->month);
        $max_month = sprintf('%04d-%02d', $first_month->year, $first_month->month);
    }

    ?>
    <div class="userinfo-month-filter-wrapper" style="display: inline-block; vertical-align: middle;">
        <label for="userinfo_month" style="margin-right: 5px; font-weight: normal;">
            <?php _e('Filter by Month:', 'userinfo-manager'); ?>
        </label>
        <input
            type="month"
            name="userinfo_month"
            id="userinfo_month"
            value="<?php echo esc_attr($selected_month); ?>"
            min="<?php echo esc_attr($min_month); ?>"
            max="<?php echo esc_attr($max_month); ?>"
            style="height: 32px; padding: 0 8px; border: 1px solid #8c8f94; border-radius: 4px; vertical-align: middle;"
            placeholder="<?php esc_attr_e('Select month...', 'userinfo-manager'); ?>"
        />
        <?php if ($selected_month): ?>
        <button
            type="button"
            id="userinfo_clear_month_filter"
            class="button"
            style="height: 32px; vertical-align: middle; margin-left: 5px;"
        >
            <?php _e('Show All', 'userinfo-manager'); ?>
        </button>
        <?php endif; ?>
    </div>

    <script type="text/javascript">
    jQuery(document).ready(function($) {
        // Auto-submit when month is selected
        $('#userinfo_month').on('change', function() {
            if ($(this).val()) {
                $(this).closest('form').submit();
            }
        });

        // Clear filter button
        $('#userinfo_clear_month_filter').on('click', function() {
            $('#userinfo_month').val('');
            $(this).closest('form').submit();
        });
    });
    </script>
    <?php
}
add_action('restrict_manage_posts', 'userinfo_add_month_filter');

/**
 * Remove default WordPress date filter dropdown
 */
function userinfo_remove_date_filter($months, $post_type) {
    if ($post_type === 'userinfo') {
        return array();
    }
    return $months;
}
add_filter('months_dropdown_results', 'userinfo_remove_date_filter', 10, 2);

/**
 * Filter posts by selected month
 */
function userinfo_filter_by_month($query) {
    global $pagenow, $typenow;

    if ($pagenow !== 'edit.php' || $typenow !== 'userinfo' || !is_admin()) {
        return;
    }

    if (!isset($_GET['userinfo_month']) || empty($_GET['userinfo_month'])) {
        return;
    }

    $selected_month = sanitize_text_field($_GET['userinfo_month']);

    // Validate format YYYY-MM
    if (!preg_match('/^\d{4}-\d{2}$/', $selected_month)) {
        return;
    }

    list($year, $month) = explode('-', $selected_month);

    $meta_query = array(
        array(
            'key'     => '_userinfo_submitted_date',
            'value'   => array(
                sprintf('%04d-%02d-01 00:00:00', $year, $month),
                sprintf('%04d-%02d-31 23:59:59', $year, $month)
            ),
            'compare' => 'BETWEEN',
            'type'    => 'DATETIME'
        )
    );

    $query->set('meta_query', $meta_query);
}
add_action('pre_get_posts', 'userinfo_filter_by_month');

/**
 * Handle sortable submitted_date column
 */
function userinfo_submitted_date_orderby($query) {
    if (!is_admin() || !$query->is_main_query()) {
        return;
    }

    $orderby = $query->get('orderby');

    if ('submitted_date' === $orderby) {
        $query->set('meta_key', '_userinfo_submitted_date');
        $query->set('orderby', 'meta_value');
    }
}
add_action('pre_get_posts', 'userinfo_submitted_date_orderby');

/**
 * Add export button to admin toolbar
 */
function userinfo_add_export_button() {
    global $typenow;

    if ($typenow !== 'userinfo') {
        return;
    }

    $selected_month = isset($_GET['userinfo_month']) ? sanitize_text_field($_GET['userinfo_month']) : '';
    $nonce = wp_create_nonce('userinfo_export_csv');

    ?>
    <script type="text/javascript">
        jQuery(document).ready(function($) {
            var exportButton = $('<input type="button" class="button button-primary" value="<?php _e('Export to CSV', 'userinfo-manager'); ?>" style="margin-left: 10px;">');

            exportButton.on('click', function() {
                var month = '<?php echo esc_js($selected_month); ?>';
                var url = '<?php echo admin_url('admin-post.php'); ?>';
                var params = {
                    action: 'userinfo_export_csv',
                    nonce: '<?php echo $nonce; ?>'
                };

                if (month) {
                    params.month = month;
                }

                window.location.href = url + '?' + $.param(params);
            });

            $('.tablenav.bottom .alignleft.actions').first().append(exportButton);
        });
    </script>
    <?php
}
add_action('admin_footer-edit.php', 'userinfo_add_export_button');

/**
 * Handle CSV export
 */
function userinfo_export_csv() {
    // Check if user has permission
    if (!current_user_can('edit_posts')) {
        wp_die(__('You do not have permission to export data.', 'userinfo-manager'));
    }

    // Verify nonce
    if (!isset($_GET['nonce']) || !wp_verify_nonce($_GET['nonce'], 'userinfo_export_csv')) {
        wp_die(__('Security check failed.', 'userinfo-manager'));
    }

    // Build query arguments
    $args = array(
        'post_type'      => 'userinfo',
        'post_status'    => 'publish',
        'posts_per_page' => -1,
        'orderby'        => 'date',
        'order'          => 'DESC'
    );

    // Check if filtering by month
    if (isset($_GET['month']) && !empty($_GET['month'])) {
        $selected_month = sanitize_text_field($_GET['month']);

        // Validate format YYYY-MM
        if (preg_match('/^\d{4}-\d{2}$/', $selected_month)) {
            list($year, $month) = explode('-', $selected_month);

            $args['meta_query'] = array(
                array(
                    'key'     => '_userinfo_submitted_date',
                    'value'   => array(
                        sprintf('%04d-%02d-01 00:00:00', $year, $month),
                        sprintf('%04d-%02d-31 23:59:59', $year, $month)
                    ),
                    'compare' => 'BETWEEN',
                    'type'    => 'DATETIME'
                )
            );
        }
    }

    // Get posts
    $posts = get_posts($args);

    // Generate filename
    $filename = 'userinfo-export-' . date('Y-m-d-His') . '.csv';

    if (isset($_GET['month']) && !empty($_GET['month'])) {
        $filename = 'userinfo-export-' . sanitize_file_name($_GET['month']) . '-' . date('Y-m-d-His') . '.csv';
    }

    // Generate and download CSV using helper function
    userinfo_generate_csv_download($posts, $filename);
    exit;
}
add_action('admin_post_userinfo_export_csv', 'userinfo_export_csv');

/**
 * AJAX handler to toggle valid member status
 */
function userinfo_ajax_toggle_valid_status() {
    // Check nonce
    check_ajax_referer('userinfo_toggle_valid', 'nonce');

    // Check permissions
    if (!current_user_can('edit_posts')) {
        wp_send_json_error(array('message' => __('Permission denied', 'userinfo-manager')));
    }

    // Get post ID
    $post_id = isset($_POST['post_id']) ? intval($_POST['post_id']) : 0;

    if (!$post_id) {
        wp_send_json_error(array('message' => __('Invalid post ID', 'userinfo-manager')));
    }

    // Get current status
    $current_status = get_post_meta($post_id, '_userinfo_is_valid', true);

    // Default to valid if not set
    if ($current_status === '') {
        $current_status = '1';
    }

    // Toggle status
    $new_status = ($current_status == '1') ? '0' : '1';

    // Update meta
    update_post_meta($post_id, '_userinfo_is_valid', $new_status);

    // Return success with new status
    wp_send_json_success(array(
        'status' => $new_status,
        'message' => ($new_status == '1') ? __('Member marked as valid', 'userinfo-manager') : __('Member marked as invalid', 'userinfo-manager')
    ));
}
add_action('wp_ajax_userinfo_toggle_valid_status', 'userinfo_ajax_toggle_valid_status');

/**
 * Enqueue admin scripts and styles for toggle switches
 */
function userinfo_enqueue_admin_assets($hook) {
    global $post_type;

    // Only load on userinfo pages
    if ($post_type !== 'userinfo' && $hook !== 'edit.php') {
        return;
    }

    // Add inline CSS for toggle switch
    add_action('admin_head', 'userinfo_admin_toggle_styles');

    // Add inline JavaScript for toggle functionality
    add_action('admin_footer', 'userinfo_admin_toggle_scripts');
}
add_action('admin_enqueue_scripts', 'userinfo_enqueue_admin_assets');

/**
 * Toggle switch CSS styles
 */
function userinfo_admin_toggle_styles() {
    global $post_type, $pagenow;

    // Only output on userinfo pages
    if ($post_type !== 'userinfo' && !($pagenow === 'edit.php' && isset($_GET['post_type']) && $_GET['post_type'] === 'userinfo')) {
        return;
    }
    ?>
    <style>
        /* Toggle Switch Styles */
        .userinfo-toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin: 0;
        }

        .userinfo-toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .userinfo-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #dc3232;
            transition: .4s;
            border-radius: 24px;
        }

        .userinfo-toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .userinfo-toggle-switch input:checked + .userinfo-toggle-slider {
            background-color: #46b450;
        }

        .userinfo-toggle-switch input:checked + .userinfo-toggle-slider:before {
            transform: translateX(26px);
        }

        .userinfo-toggle-switch.loading .userinfo-toggle-slider {
            opacity: 0.5;
            cursor: wait;
        }

        .userinfo-toggle-label {
            display: inline-block;
            margin-left: 8px;
            vertical-align: middle;
            font-weight: 600;
        }

        .userinfo-toggle-label.valid {
            color: #46b450;
        }

        .userinfo-toggle-label.invalid {
            color: #dc3232;
        }

        /* Details view toggle container */
        .userinfo-details-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
        }
    </style>
    <?php
}

/**
 * Toggle switch JavaScript
 */
function userinfo_admin_toggle_scripts() {
    global $post_type, $pagenow;

    // Only output on userinfo pages
    if ($post_type !== 'userinfo' && !($pagenow === 'edit.php' && isset($_GET['post_type']) && $_GET['post_type'] === 'userinfo')) {
        return;
    }
    ?>
    <script type="text/javascript">
    jQuery(document).ready(function($) {
        // Handle toggle switch clicks
        $('.userinfo-toggle-switch input').on('change', function() {
            var $toggle = $(this).closest('.userinfo-toggle-switch');
            var $label = $toggle.siblings('.userinfo-toggle-label');
            var postId = $toggle.data('post-id');
            var isChecked = $(this).is(':checked');

            // Add loading state
            $toggle.addClass('loading');

            // Make AJAX request
            $.ajax({
                url: ajaxurl,
                type: 'POST',
                data: {
                    action: 'userinfo_toggle_valid_status',
                    post_id: postId,
                    nonce: '<?php echo wp_create_nonce('userinfo_toggle_valid'); ?>'
                },
                success: function(response) {
                    if (response.success) {
                        // Update label
                        if (response.data.status == '1') {
                            $label.text('<?php echo esc_js(__('Valid', 'userinfo-manager')); ?>')
                                  .removeClass('invalid')
                                  .addClass('valid');
                        } else {
                            $label.text('<?php echo esc_js(__('Invalid', 'userinfo-manager')); ?>')
                                  .removeClass('valid')
                                  .addClass('invalid');
                        }

                        // Update hidden field if in details view
                        $('#userinfo_is_valid').val(response.data.status);

                        // Show success message briefly
                        if (typeof wp !== 'undefined' && wp.data) {
                            // WordPress 5.0+ notice
                            wp.data.dispatch('core/notices').createNotice(
                                'success',
                                response.data.message,
                                {
                                    isDismissible: true,
                                    type: 'snackbar'
                                }
                            );
                        }
                    } else {
                        // Revert toggle on error
                        $toggle.find('input').prop('checked', !isChecked);
                        alert(response.data.message || '<?php echo esc_js(__('Error updating status', 'userinfo-manager')); ?>');
                    }
                },
                error: function() {
                    // Revert toggle on error
                    $toggle.find('input').prop('checked', !isChecked);
                    alert('<?php echo esc_js(__('Error updating status', 'userinfo-manager')); ?>');
                },
                complete: function() {
                    // Remove loading state
                    $toggle.removeClass('loading');
                }
            });
        });
    });
    </script>
    <?php
}

/**
 * Register bulk action for exporting selected items
 */
function userinfo_register_bulk_actions($bulk_actions) {
    $bulk_actions['export_selected_csv'] = __('Export to CSV', 'userinfo-manager');
    return $bulk_actions;
}
add_filter('bulk_actions-edit-userinfo', 'userinfo_register_bulk_actions');

/**
 * Handle bulk export action
 */
function userinfo_handle_bulk_export($redirect_to, $action, $post_ids) {
    if ($action !== 'export_selected_csv') {
        return $redirect_to;
    }

    // Check permissions
    if (!current_user_can('edit_posts')) {
        wp_die(__('You do not have permission to export data.', 'userinfo-manager'));
    }

    // Validate post IDs
    if (empty($post_ids)) {
        return $redirect_to;
    }

    // Get posts by IDs
    $args = array(
        'post_type'      => 'userinfo',
        'post_status'    => 'publish',
        'posts_per_page' => -1,
        'post__in'       => $post_ids,
        'orderby'        => 'date',
        'order'          => 'DESC'
    );

    $posts = get_posts($args);

    if (empty($posts)) {
        return $redirect_to;
    }

    // Generate filename
    $filename = 'userinfo-export-selected-' . date('Y-m-d-His') . '.csv';

    // Generate and download CSV
    userinfo_generate_csv_download($posts, $filename);

    // Exit to prevent redirect
    exit;
}
add_filter('handle_bulk_actions-edit-userinfo', 'userinfo_handle_bulk_export', 10, 3);

/**
 * Helper function to generate and download CSV from posts array
 */
function userinfo_generate_csv_download($posts, $filename) {
    // Set headers for CSV download
    header('Content-Type: text/csv; charset=utf-8');
    header('Content-Disposition: attachment; filename=' . $filename);
    header('Pragma: no-cache');
    header('Expires: 0');

    // Create output stream
    $output = fopen('php://output', 'w');

    // Add BOM for UTF-8
    fprintf($output, chr(0xEF).chr(0xBB).chr(0xBF));

    // Add CSV headers
    fputcsv($output, array(
        __('Full Name', 'userinfo-manager'),
        __('Username', 'userinfo-manager'),
        __('Agent ID', 'userinfo-manager'),
        __('Phone Number', 'userinfo-manager'),
        __('NID Number', 'userinfo-manager'),
        __('NID Image URL', 'userinfo-manager'),
        __('Submitted Date', 'userinfo-manager'),
        __('Post Date', 'userinfo-manager'),
        __('Valid Member', 'userinfo-manager')
    ));

    // Add data rows
    if (!empty($posts)) {
        foreach ($posts as $post) {
            $full_name = get_post_meta($post->ID, '_userinfo_full_name', true);
            $username = get_post_meta($post->ID, '_userinfo_username', true);
            $agent_id = get_post_meta($post->ID, '_userinfo_agent_id', true);
            $phone_number = get_post_meta($post->ID, '_userinfo_phone_number', true);
            $nid_number = get_post_meta($post->ID, '_userinfo_nid_number', true);
            $submitted_date = get_post_meta($post->ID, '_userinfo_submitted_date', true);
            $nid_image_id = get_post_meta($post->ID, '_userinfo_nid_image', true);
            $is_valid = get_post_meta($post->ID, '_userinfo_is_valid', true);

            $formatted_submitted_date = $submitted_date ? date_i18n(get_option('date_format') . ' ' . get_option('time_format'), strtotime($submitted_date)) : 'N/A';
            $formatted_post_date = date_i18n(get_option('date_format') . ' ' . get_option('time_format'), strtotime($post->post_date));
            $nid_image_url = $nid_image_id ? wp_get_attachment_url($nid_image_id) : '';

            // Default to valid if not set
            if ($is_valid === '') {
                $is_valid = '1';
            }
            $valid_status = ($is_valid == '1') ? __('Valid', 'userinfo-manager') : __('Invalid', 'userinfo-manager');

            fputcsv($output, array(
                $full_name,
                $username,
                $agent_id,
                $phone_number,
                $nid_number,
                $nid_image_url,
                $formatted_submitted_date,
                $formatted_post_date,
                $valid_status
            ));
        }
    }

    // Close output stream
    fclose($output);
}

/**
 * AJAX handler to verify user by phone and NID
 */
function userinfo_ajax_verify_user() {
    // Check nonce
    check_ajax_referer('userinfo_verify_user', 'nonce');

    // Get inputs
    $phone_number = isset($_POST['phone_number']) ? sanitize_text_field($_POST['phone_number']) : '';
    $nid_number = isset($_POST['nid_number']) ? sanitize_text_field($_POST['nid_number']) : '';

    // Validate inputs
    if (empty($phone_number) || empty($nid_number)) {
        wp_send_json_error(array(
            'message' => __('Please enter both Phone Number and NID Number', 'userinfo-manager')
        ));
    }

    // Query for user with matching phone and NID
    $args = array(
        'post_type'      => 'userinfo',
        'post_status'    => 'publish',
        'posts_per_page' => 1,
        'meta_query'     => array(
            'relation' => 'AND',
            array(
                'key'     => '_userinfo_phone_number',
                'value'   => $phone_number,
                'compare' => '='
            ),
            array(
                'key'     => '_userinfo_nid_number',
                'value'   => $nid_number,
                'compare' => '='
            )
        )
    );

    $posts = get_posts($args);

    if (empty($posts)) {
        wp_send_json_error(array(
            'message' => __('No matching user found. Please check your Phone Number and NID Number.', 'userinfo-manager'),
            'found' => false
        ));
    }

    // User found - get details
    $post = $posts[0];
    $full_name = get_post_meta($post->ID, '_userinfo_full_name', true);
    $username = get_post_meta($post->ID, '_userinfo_username', true);
    $agent_id = get_post_meta($post->ID, '_userinfo_agent_id', true);
    $is_valid = get_post_meta($post->ID, '_userinfo_is_valid', true);
    $nid_image_id = get_post_meta($post->ID, '_userinfo_nid_image', true);

    // Default to valid if not set
    if ($is_valid === '') {
        $is_valid = '1';
    }

    $nid_image_url = $nid_image_id ? wp_get_attachment_url($nid_image_id) : '';

    wp_send_json_success(array(
        'found' => true,
        'full_name' => $full_name,
        'username' => $username,
        'agent_id' => $agent_id,
        'phone_number' => $phone_number,
        'nid_number' => $nid_number,
        'is_valid' => $is_valid,
        'nid_image_url' => $nid_image_url,
        'valid_text' => ($is_valid == '1') ? __('Valid', 'userinfo-manager') : __('Invalid', 'userinfo-manager')
    ));
}
add_action('wp_ajax_userinfo_verify_user', 'userinfo_ajax_verify_user');
add_action('wp_ajax_nopriv_userinfo_verify_user', 'userinfo_ajax_verify_user');

/**
 * Enqueue jQuery for verification form
 */
function userinfo_enqueue_verification_scripts() {
    global $post;
    if (is_a($post, 'WP_Post') && has_shortcode($post->post_content, 'userinfo_check')) {
        wp_enqueue_script('jquery');
    }
}
add_action('wp_enqueue_scripts', 'userinfo_enqueue_verification_scripts');

/**
 * Shortcode for user verification form
 * Usage: [userinfo_check]
 */
function userinfo_check_shortcode($atts) {
    // Verification form JavaScript is now handled in userinfo-frontend.js
    // No inline scripts needed

    ob_start();
    ?>
    <div class="userinfo-check-container">
        <div class="userinfo-check-form-wrapper">
            <h2>
                <?php _e('Check User Validity', 'userinfo-manager'); ?>
            </h2>

            <form id="userinfo-check-form" class="userinfo-check-form">
                <?php wp_nonce_field('userinfo_verify_user', 'userinfo_verify_nonce'); ?>

                <div class="form-group">
                    <label for="check_phone_number">
                        <?php _e('Phone Number', 'userinfo-manager'); ?> <span style="color: #f5576c;">*</span>
                        <span class="info-icon" data-tooltip="<?php esc_attr_e('Numbers only, 10-50 characters', 'userinfo-manager'); ?>">ℹ️</span>
                    </label>
                    <input
                        type="text"
                        id="check_phone_number"
                        name="phone_number"
                        required
                        pattern="[0-9]{10,50}"
                        minlength="10"
                        maxlength="50"
                        title="<?php esc_attr_e('Phone number must be 10-50 digits only', 'userinfo-manager'); ?>"
                        placeholder="<?php esc_attr_e('মোবাইল নাম্বার লিখুন', 'userinfo-manager'); ?>"
                    />
                </div>

                <div class="form-group">
                    <label for="check_nid_number">
                        <?php _e('NID Number', 'userinfo-manager'); ?> <span style="color: #f5576c;">*</span>
                        <span class="info-icon" data-tooltip="<?php esc_attr_e('Numbers only, 10-50 characters', 'userinfo-manager'); ?>">ℹ️</span>
                    </label>
                    <input
                        type="text"
                        id="check_nid_number"
                        name="nid_number"
                        required
                        pattern="[0-9]{10,50}"
                        minlength="10"
                        maxlength="50"
                        title="<?php esc_attr_e('NID number must be 10-50 digits only', 'userinfo-manager'); ?>"
                        placeholder="<?php esc_attr_e('এনআইডি নাম্বার লিখুন', 'userinfo-manager'); ?>"
                    />
                </div>

                <div class="form-group full-width">
                    <button type="submit" id="verify-btn">
                        <span><?php _e('Verify User', 'userinfo-manager'); ?></span>
                    </button>
                </div>
            </form>

            <div id="verification-result"></div>
        </div>
    </div>

    <?php
    return ob_get_clean();
}
add_shortcode('userinfo_check', 'userinfo_check_shortcode');

/**
 * NOTE: All styles for verification form are now in assets/css/userinfo-frontend.css
 * Inline styles have been removed to prevent conflicts with themes
 */

/**
 * Tabbed interface shortcode combining registration and status check
 * Usage: [userinfo_tabs]
 */
function userinfo_tabs_shortcode($atts) {
    // Tab switching is now handled in userinfo-frontend.js
    // No inline scripts needed

    ob_start();

    // Get plugin URL for logo
    $plugin_url = plugin_dir_url(__FILE__);
    $logo_url = $plugin_url . 'assets/logo.webp';
    ?>
    <div class="userinfo-page-wrapper">
        <!-- Company Logo - Outside Form -->
        <div class="userinfo-company-logo">
            <img src="<?php echo esc_url($logo_url); ?>" alt="<?php esc_attr_e('Company Logo', 'userinfo-manager'); ?>">
        </div>

        <div class="userinfo-tabs-container">
            <!-- Tab Navigation -->
            <div class="userinfo-tab-navigation">
            <button class="userinfo-tab-btn active" data-tab="registration">
                <span class="tab-icon">📝</span>
                <?php _e('Registration', 'userinfo-manager'); ?>
            </button>
            <button class="userinfo-tab-btn" data-tab="status-check">
                <span class="tab-icon">✓</span>
                <?php _e('Status Check', 'userinfo-manager'); ?>
            </button>
        </div>

        <!-- Tab Content -->
        <div class="userinfo-tab-content-wrapper">
            <!-- Registration Tab Content -->
            <div id="registration-tab" class="userinfo-tab-content active">
                <?php echo do_shortcode('[userinfo_form]'); ?>
            </div>

            <!-- Status Check Tab Content -->
            <div id="status-check-tab" class="userinfo-tab-content">
                <?php echo do_shortcode('[userinfo_check]'); ?>
            </div>
        </div>
        </div>

        <!-- Footer - Visit Website Button -->
        <div class="userinfo-footer">
            <a href="https://agent9w.com/9wicket-master-agent/" target="_blank" rel="noopener noreferrer" class="visit-website-btn">
                <svg class="agent-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12Z" fill="currentColor"/>
                    <path d="M12 14C8.13 14 5 15.57 5 17.5V20H19V17.5C19 15.57 15.87 14 12 14Z" fill="currentColor"/>
                </svg>
                <span><?php _e('আমাদের এজেন্টস', 'userinfo-manager'); ?></span>
                <svg class="external-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 13V19C18 19.5304 17.7893 20.0391 17.4142 20.4142C17.0391 20.7893 16.5304 21 16 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V8C3 7.46957 3.21071 6.96086 3.58579 6.58579C3.96086 6.21071 4.46957 6 5 6H11M15 3H21M21 3V9M21 3L10 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </a>
        </div>
    </div>

    <style>
        /* Agent9w.com Inspired Design */
        /* Page Wrapper */
        .userinfo-page-wrapper {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FF8C00 100%);
            min-height: 100vh;
        }

        /* Company Logo - Outside Form */
        .userinfo-company-logo {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            margin-bottom: 30px;
        }

        .userinfo-company-logo img {
            max-width: 200px;
            height: auto;
            filter: drop-shadow(3px 3px 6px rgba(0, 0, 0, 0.15));
            transition: transform 0.3s ease;
        }

        .userinfo-company-logo img:hover {
            transform: scale(1.05);
        }

        /* Footer - Visit Website Button */
        .userinfo-footer {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 30px 20px;
            margin-top: 30px;
        }

        .visit-website-btn {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            padding: 14px 32px;
            background: #FEBE1E;
            color: #000000;
            text-decoration: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 700;
            font-family: 'Open Sans', Arial, sans-serif;
            border: 2px solid #FEBE1E;
            box-shadow: 6px 6px 9px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .visit-website-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: #000000;
            transition: left 0.3s ease;
            z-index: 0;
        }

        .visit-website-btn:hover::before {
            left: 0;
        }

        .visit-website-btn:hover {
            color: #ffffff;
            border-color: #000000;
            transform: translateY(-2px);
            box-shadow: 8px 8px 12px rgba(0, 0, 0, 0.3);
        }

        .visit-website-btn span,
        .visit-website-btn svg {
            position: relative;
            z-index: 1;
        }

        .agent-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        .external-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            opacity: 0.8;
        }

        .visit-website-btn:hover .external-icon {
            opacity: 1;
            transform: translateX(2px) translateY(-2px);
            transition: all 0.3s ease;
        }

        /* Container & Layout - Glassmorphism */
        .userinfo-tabs-container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(30px) saturate(200%);
            -webkit-backdrop-filter: blur(30px) saturate(200%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37),
                        0 2px 8px 0 rgba(255, 255, 255, 0.1),
                        inset 0 1px 0 0 rgba(255, 255, 255, 0.6);
            overflow: hidden;
            position: relative;
            font-family: 'Open Sans', Arial, sans-serif;
        }

        /* Tab Navigation - Glassmorphism */
        .userinfo-tab-navigation {
            display: flex;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 0;
            margin: 0;
            position: relative;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .userinfo-tab-btn {
            flex: 1;
            padding: 18px 24px;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        /* Ripple Effect on Tab Click */
        .userinfo-tab-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(254, 190, 30, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .userinfo-tab-btn:active::before {
            width: 300px;
            height: 300px;
        }

        .userinfo-tab-btn:hover {
            background: #FEBE1E;
            color: #000000;
        }

        .userinfo-tab-btn.active {
            background: #FEBE1E;
            color: #000000;
            border-bottom-color: #000000;
        }

        .tab-icon {
            font-size: 22px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .userinfo-tab-btn:hover .tab-icon {
            transform: scale(1.15) rotate(5deg);
        }

        .userinfo-tab-btn.active .tab-icon {
            transform: scale(1.1);
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        /* Content Wrapper - Glassmorphism */
        .userinfo-tab-content-wrapper {
            padding: 40px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            min-height: 400px;
            position: relative;
        }

        /* Tab Content with Advanced Animations */
        .userinfo-tab-content {
            display: none;
            opacity: 0;
            transform: translateX(-30px) scale(0.97);
        }

        .userinfo-tab-content.active {
            display: block;
            animation: slideInScale 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .userinfo-tab-content.slide-out {
            animation: slideOutScale 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes slideInScale {
            0% {
                opacity: 0;
                transform: translateX(-30px) scale(0.97);
            }
            60% {
                transform: translateX(5px) scale(1.01);
            }
            100% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        @keyframes slideOutScale {
            0% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateX(30px) scale(0.97);
            }
        }

        /* Agent9w.com Form Styling */
        .userinfo-tab-content .userinfo-form-container,
        .userinfo-tab-content .userinfo-check-container {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37),
                        inset 0 1px 1px 0 rgba(255, 255, 255, 0.5);
        }

        /* Two-Column Grid Layout for Form Fields */
        .userinfo-tab-content form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .userinfo-tab-content .form-group {
            margin-bottom: 0;
            position: relative;
        }

        /* Full-width fields */
        .userinfo-tab-content .form-group.full-width {
            grid-column: 1 / -1;
        }

        .userinfo-tab-content label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: #000000;
            font-size: 15px;
            letter-spacing: 0.3px;
            text-shadow: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .userinfo-tab-content input[type="text"],
        .userinfo-tab-content input[type="email"],
        .userinfo-tab-content input[type="tel"],
        .userinfo-tab-content input[type="file"] {
            width: 100%;
            padding: 12px 16px;
            height: 44px;
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            color: #000000;
            box-sizing: border-box;
            font-family: 'Open Sans', Arial, sans-serif;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .userinfo-tab-content input[type="text"]::placeholder,
        .userinfo-tab-content input[type="email"]::placeholder,
        .userinfo-tab-content input[type="tel"]::placeholder {
            color: #666666;
            font-weight: 400;
            opacity: 1;
        }

        .userinfo-tab-content input[type="text"]:focus,
        .userinfo-tab-content input[type="email"]:focus,
        .userinfo-tab-content input[type="tel"]:focus {
            border-color: #FEBE1E;
            background: #ffffff;
            outline: none;
            box-shadow: 0 0 20px rgba(254, 190, 30, 0.6),
                        0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .userinfo-tab-content input[type="file"] {
            padding: 12px;
            cursor: pointer;
        }

        .userinfo-tab-content input[type="file"]:hover {
            border-color: #667eea;
            background: #ffffff;
        }

        .userinfo-tab-content small {
            display: block;
            margin-top: 6px;
            color: #6c757d;
            font-size: 13px;
            font-style: italic;
        }

        .userinfo-tab-content button[type="submit"],
        .userinfo-tab-content .userinfo-tab-content button {
            width: 100%;
            min-width: 215px;
            padding: 14px 32px;
            background: #FEBE1E;
            color: #000000;
            border: 2px solid #FEBE1E;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: none;
            letter-spacing: 0.3px;
            margin-top: 20px;
            font-family: 'Open Sans', Arial, sans-serif;
            box-shadow: 6px 6px 9px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .userinfo-tab-content button[type="submit"]::before,
        .userinfo-tab-content .userinfo-tab-content button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: #000000;
            transition: left 0.3s ease;
            z-index: 0;
        }

        .userinfo-tab-content button[type="submit"]:hover::before,
        .userinfo-tab-content .userinfo-tab-content button:hover::before {
            left: 0;
        }

        .userinfo-tab-content button[type="submit"]:hover,
        .userinfo-tab-content .userinfo-tab-content button:hover {
            color: #ffffff;
            border-color: #000000;
            transform: translateY(-2px);
            box-shadow: 8px 8px 12px rgba(0, 0, 0, 0.3);
        }

        .userinfo-tab-content button[type="submit"] > *,
        .userinfo-tab-content .userinfo-tab-content button > * {
            position: relative;
            z-index: 1;
        }

        .userinfo-tab-content button[type="submit"]:focus,
        .userinfo-tab-content .userinfo-tab-content button:focus {
            outline: none;
            box-shadow: 0px 0px 5px 0px rgba(254, 190, 31, 0.6);
        }

        .userinfo-tab-content button[type="submit"]:active,
        .userinfo-tab-content .userinfo-tab-content button:active {
            transform: translateY(-1px);
        }

        /* Success & Error Messages - Agent9w.com Style */
        .userinfo-tab-content .userinfo-success,
        .userinfo-tab-content .userinfo-errors {
            border-radius: 2px;
            padding: 15px 20px;
            margin-bottom: 20px;
            animation: slideDown 0.4s ease-out;
            border: 1px solid;
            font-weight: 600;
        }

        .userinfo-tab-content .userinfo-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .userinfo-tab-content .userinfo-errors {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading State */
        .userinfo-tab-content button[disabled] {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            /* Stack form fields vertically on mobile */
            .userinfo-tab-content form {
                grid-template-columns: 1fr;
            }

            .userinfo-page-wrapper {
                padding: 15px;
            }

            .userinfo-company-logo {
                padding: 15px;
                margin-bottom: 20px;
            }

            .userinfo-company-logo img {
                max-width: 150px;
            }

            .userinfo-footer {
                padding: 25px 15px;
                margin-top: 25px;
            }

            .visit-website-btn {
                padding: 12px 28px;
                font-size: 15px;
                gap: 10px;
            }

            .agent-icon {
                width: 22px;
                height: 22px;
            }

            .external-icon {
                width: 14px;
                height: 14px;
            }

            .userinfo-tabs-container {
                border-radius: 12px;
            }

            .userinfo-tab-btn {
                padding: 16px 12px;
                font-size: 15px;
            }

            .tab-icon {
                font-size: 20px;
            }

            .userinfo-tab-content-wrapper {
                padding: 24px 16px;
            }

            .userinfo-tab-content .userinfo-form-container,
            .userinfo-tab-content .userinfo-check-container {
                padding: 24px 16px;
            }
        }

        @media (max-width: 480px) {
            .userinfo-page-wrapper {
                padding: 10px;
            }

            .userinfo-company-logo {
                padding: 10px;
                margin-bottom: 15px;
            }

            .userinfo-company-logo img {
                max-width: 120px;
            }

            .userinfo-footer {
                padding: 20px 10px;
                margin-top: 20px;
            }

            .visit-website-btn {
                padding: 12px 24px;
                font-size: 14px;
                gap: 8px;
            }

            .agent-icon {
                width: 20px;
                height: 20px;
            }

            .external-icon {
                width: 12px;
                height: 12px;
            }

            .userinfo-tab-btn {
                flex-direction: column;
                gap: 6px;
                padding: 14px 8px;
                font-size: 13px;
            }

            .tab-icon {
                font-size: 26px;
            }

            .userinfo-tab-content-wrapper {
                padding: 20px 12px;
            }

            .userinfo-tab-content .userinfo-form-container,
            .userinfo-tab-content .userinfo-check-container {
                padding: 20px 12px;
            }
        }
    </style>

    <?php
    return ob_get_clean();
}
add_shortcode('userinfo_tabs', 'userinfo_tabs_shortcode');

/**
 * Hide header and footer when userinfo_tabs shortcode is used
 */
function userinfo_hide_header_footer() {
    global $post;

    // Check if we're on a single page/post with the shortcode
    if (is_singular() && is_a($post, 'WP_Post') && has_shortcode($post->post_content, 'userinfo_tabs')) {
        // Add body class for styling
        add_filter('body_class', 'userinfo_add_no_header_footer_class');

        // Add custom template filter
        add_filter('template_include', 'userinfo_blank_template');
    }
}
add_action('wp', 'userinfo_hide_header_footer');

/**
 * Add custom body class when shortcode is used
 */
function userinfo_add_no_header_footer_class($classes) {
    $classes[] = 'userinfo-fullwidth-page';
    $classes[] = 'no-header';
    $classes[] = 'no-footer';
    return $classes;
}

/**
 * Use blank template for pages with userinfo_tabs shortcode
 */
function userinfo_blank_template($template) {
    global $post;

    if (is_singular() && is_a($post, 'WP_Post') && has_shortcode($post->post_content, 'userinfo_tabs')) {
        // Output blank template directly
        userinfo_output_blank_template();
        exit;
    }

    return $template;
}

/**
 * Output blank template HTML without header/footer
 */
function userinfo_output_blank_template() {
    global $post;

    // Set up post data
    setup_postdata($post);
    ?>
    <!DOCTYPE html>
    <html <?php language_attributes(); ?>>
    <head>
        <meta charset="<?php bloginfo('charset'); ?>">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <?php wp_head(); ?>
        <style>
            /* Remove default WordPress admin bar spacing */
            html { margin-top: 0 !important; }
            * html body { margin-top: 0 !important; }

            /* Full width layout */
            body.userinfo-fullwidth-page {
                margin: 0;
                padding: 20px;
                background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FF8C00 100%);
                min-height: 100vh;
            }

            /* Hide all header and footer elements */
            .userinfo-fullwidth-page .site-header,
            .userinfo-fullwidth-page header,
            .userinfo-fullwidth-page .site-footer,
            .userinfo-fullwidth-page footer,
            .userinfo-fullwidth-page .site-navigation,
            .userinfo-fullwidth-page nav,
            .userinfo-fullwidth-page .header,
            .userinfo-fullwidth-page .footer,
            .userinfo-fullwidth-page #header,
            .userinfo-fullwidth-page #footer,
            .userinfo-fullwidth-page #masthead,
            .userinfo-fullwidth-page #colophon {
                display: none !important;
            }

            /* Center the content */
            .userinfo-fullwidth-page .site-content,
            .userinfo-fullwidth-page main,
            .userinfo-fullwidth-page .content-area,
            .userinfo-fullwidth-page #content,
            .userinfo-fullwidth-page #primary {
                width: 100%;
                max-width: 100%;
                margin: 0;
                padding: 20px;
            }

            /* Remove any extra padding/margin */
            .userinfo-fullwidth-page .entry-content,
            .userinfo-fullwidth-page .page-content {
                margin: 0;
                padding: 0;
            }
        </style>
    </head>
    <body <?php body_class('userinfo-fullwidth-page'); ?>>
        <?php
        // Output the post content with the shortcode
        if (have_posts()) {
            while (have_posts()) {
                the_post();
                ?>
                <div class="userinfo-blank-wrapper">
                    <?php the_content(); ?>
                </div>
                <?php
            }
        }
        wp_reset_postdata();
        ?>
        <?php wp_footer(); ?>
    </body>
    </html>
    <?php
}

